# 科研管理系统思路

## 前言
整个系统从最开始到现在已经改动无数次了，整个框架都不算稳定。  
虽然中间多次推翻重来，但也存在很多历史遗留问题。  
希望能逐渐叙述清整个系统

## 工作流
最开始的图方便，现在已经成了整个系统的痛点之一，系统使用的`snaker`工作流，一个国人开发的轻量级引擎，有点是中文，缺点是文档太少，整个使用基本是黑箱一步步调试来的。
该工作流的概念有`process`，`order`，`task`
process为一个流程，也可以成为一个流程模板。
order是process实例化的一个对象，由一个个的task节点组成。
流程的进行，就是执行一个一个task，每次执行task都会生成下一个task（结束或者停止除外）
execute函数接受actor和一个argMap
//待续


## 数据库
### `OrderActor`
+ 此为关系表，其中`role`为0表示参与，1表示负责，2表示所属审批学院，3表示所属审批部门
+ 表中的`status`用于表示该流程是否有效，一般1表示处于流程中，0表示已完毕或者已停止
+ 表中的`actor_id`并不一定为`staff`的id，有可能为部门的id ；）
+ ……

### `Staff`与`User`
+ 分成两张表，实际上还是杂糅在一起
+ Staff表为员工表，规定ID在4位(含)以上的为普通员工，4位以下为各类特殊账户
+ 权限1，2，3分别对应普通员工，学院，学校
+ 学院管理帐号的学院对应其所管理的范围 ex:张三的权限是2，学院是`信息工程学院`,则张三会看到所有`信息工程学院`的流程和实体

### `各种entity`
+ 在数据库中可能各不相同，但是在其映射的实体pojo中，均有`arg`，`standard`,`dept`,`process`这几个field
+ `standard`表示该实体的算分规则，部分实体类由于其本身的特殊性，是没有`standard`的
+ `arg`是存储各种非规则性数据的字段，在实体pojo中一般不直接调用，而是使用`argMap`
+ `dept`是设置实体所属部门的，可能被遗弃
+ `process`是表示该实体状态，一般0表示未启动，1表示正在流程中，9表示已完结

### `StaRef`
+ `type`和`entityId`共同确定所关联的实体
+ 这张表是一张关键表，计算分数之类的完全由该表实现


### 其他
数据库使用的Mysql，基本没有使用什么高级特性，可能存在的问题有：
+ 直接把对象以json的格式存入数据库，查询不方便，语义不明确
+ 所有的主键都是varchar型，在部分表的筛选使用上不太方便
+ 将部分表抽出来的必要性不高，反而影响查询效率
+ 用户与各个对象之间的关系在多处维护，较为复杂
+ Magic数值过多
+ ……


## Dao层
DAO是使用的Hibernate，加以简单的封装，里面存在很多问题
+ 功能可见`BaseDaoImp`实现
+ 没有缓存，存在性能问题
+ 使用的是拼合HQL，***存在注入问题***
+ 所有的查询都是全投影，性能可能会有问题
+ 很多功能实现的查询需要手动写语句，但还处于空缺状态
+ ……

## Service层
也没有什么特殊的地方，也是有个通用基础类`BaseServiceImp`
稍微复杂一点的在于`StaRefServiceImp`
还需要注意的地方在于`事物管理`，由于最开始对`事物管理`不够熟练，事物切面是根据`method`来进行的，具体可见`applicationContext.xml`


## 前台框架和前后台通信
是Restful接口和MVC的混合使用，首页使用前端作为路由，使用的js工具为StateMan。
各个详情界面或者编辑界面使用的MVC和接口混合。

## 各类配置文件
### `web.xml`
由于没来得及从`jersey`迁移到`springMvc`，所以使用了两个`servlet-mapping`,建议后期完成迁移，`springMvc`社区更加活跃

### workflow
见官方文档

### hbm
里面的三个`hbm.xml`作用是覆盖`snaker`的默认类型（因为最初的错误用法，导致`variable`不够用）

### log4j2.json
顾名思义，log4j2的配置文件，但是基本没用，可删除，建议重新配置。

### applicationContext.xml
用于**本项目**的`Spring`配置

### applicationContext-Snaker.xml
`snaker`的`spring`整合

### springMvc.xml
`springMvc`的配置文件


## 整体问题
系统存在的问题和bug
+ API基本没有做权限限制
+ 没有日志记录
+ 存在注入漏洞
+ 存在XSS漏洞

